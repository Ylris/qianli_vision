# Gimbal 模块

云台通信模块，用于与云台控制器进行串口通信。

## 功能

- 通过串口与云台控制器进行双向通信
- 接收云台状态信息：模式、四元数、yaw/pitch角度和角速度、子弹速度、子弹计数等
- 发送云台控制命令：控制模式、开火指令、yaw/pitch角度、角速度、角加速度
- 支持多种云台模式：空闲、自瞄、小符、大符
- 支持时间戳查询云台四元数数据
- 自动重连机制，确保通信稳定性

## 主要类

- `Gimbal`: 云台通信类
  - `mode()`: 获取当前云台模式
  - `state()`: 获取云台状态（角度、角速度、子弹速度等）
  - `q()`: 根据时间戳获取云台四元数
  - `send()`: 发送控制命令到云台

## 通信协议

### 串口参数
- 波特率：由配置文件指定
- 数据位：8位
- 停止位：1位
- 校验位：无校验
- 流控：无流控

### 数据包格式

#### 1. 云台→视觉（GimbalToVision）

**数据包结构（总长度：35字节）**

| 偏移 | 字段名 | 类型 | 大小(字节) | 说明 |
|------|--------|------|-----------|------|
| 0-1 | head | uint8_t[2] | 2 | 帧头，固定为 `{'S', 'P'}` (0x53 0x50) |
| 2 | mode | uint8_t | 1 | 云台模式：0=空闲, 1=自瞄, 2=小符, 3=大符 |
| 3-18 | q | float[4] | 16 | 四元数，顺序为 [w, x, y, z] |
| 19-22 | yaw | float | 4 | Yaw角度（弧度） |
| 23-26 | yaw_vel | float | 4 | Yaw角速度（弧度/秒） |
| 27-30 | pitch | float | 4 | Pitch角度（弧度） |
| 31-34 | pitch_vel | float | 4 | Pitch角速度（弧度/秒） |
| 35-36 | bullet_speed | float | 4 | 子弹速度（m/s） |
| 37-38 | bullet_count | uint16_t | 2 | 子弹累计发送次数 |
| 39-40 | crc16 | uint16_t | 2 | CRC16校验值（对整个数据包除CRC字段外计算） |

**总长度：41字节**

**接收流程：**
1. 先读取2字节帧头，验证是否为 `'S'` 和 `'P'`
2. 读取剩余39字节数据
3. 计算并校验CRC16
4. 解析数据并更新状态

#### 2. 视觉→云台（VisionToGimbal）

**数据包结构（总长度：31字节）**

| 偏移 | 字段名 | 类型 | 大小(字节) | 说明 |
|------|--------|------|-----------|------|
| 0-1 | head | uint8_t[2] | 2 | 帧头，固定为 `{'S', 'P'}` (0x53 0x50) |
| 2 | mode | uint8_t | 1 | 控制模式：0=不控制, 1=控制但不开火, 2=控制且开火 |
| 3-6 | yaw | float | 4 | 目标Yaw角度（弧度） |
| 7-10 | yaw_vel | float | 4 | 目标Yaw角速度（弧度/秒） |
| 11-14 | yaw_acc | float | 4 | 目标Yaw角加速度（弧度/秒²） |
| 15-18 | pitch | float | 4 | 目标Pitch角度（弧度） |
| 19-22 | pitch_vel | float | 4 | 目标Pitch角速度（弧度/秒） |
| 23-26 | pitch_acc | float | 4 | 目标Pitch角加速度（弧度/秒²） |
| 27-28 | crc16 | uint16_t | 2 | CRC16校验值（对整个数据包除CRC字段外计算） |

**总长度：29字节**

**发送流程：**
1. 填充数据包各字段
2. 计算CRC16校验值（对除CRC字段外的所有数据）
3. 通过串口发送完整数据包

### CRC16校验

- 校验算法：使用标准CRC16算法
- 校验范围：数据包中除CRC16字段外的所有字节
- 字节序：小端序（Little-Endian）

### 数据包对齐

- 使用 `__attribute__((packed))` 确保结构体紧凑排列，无内存对齐填充
- 数据包大小限制：≤ 64字节（通过 `static_assert` 检查）

### 错误处理

- 帧头校验失败：丢弃数据包，继续等待下一帧
- CRC校验失败：记录日志，丢弃数据包
- 连续错误超过5000次：触发自动重连机制

