# DM_IMU 模块

DM IMU传感器模块，用于通过串口读取DM系列IMU传感器的数据。

## 功能

- 通过串口与DM IMU传感器进行通信
- 实时读取加速度、角速度、欧拉角（roll、pitch、yaw）数据
- 将IMU数据转换为四元数格式
- 支持根据时间戳查询历史IMU数据
- 使用独立线程持续接收IMU数据

## 主要类

- `DM_IMU`: DM IMU传感器类
  - `imu_at()`: 根据时间戳获取IMU四元数数据

## 串口参数

- 设备路径：`/dev/ttyACM0`
- 波特率：921600
- 数据位：8位
- 停止位：1位
- 校验位：无校验
- 流控：无流控
- 超时：20ms

## 数据格式

### 数据帧结构

DM IMU传感器发送的数据帧为固定57字节，包含三个子数据段，每个子段包含加速度、角速度或欧拉角数据。

**完整数据帧结构（总长度：57字节）**

#### 第一段：加速度数据（17字节）

| 偏移 | 字段名 | 类型 | 大小(字节) | 说明 |
|------|--------|------|-----------|------|
| 0 | FrameHeader1 | uint8_t | 1 | 帧头1，固定为 `0x55` |
| 1 | flag1 | uint8_t | 1 | 标志1，固定为 `0xAA` |
| 2 | slave_id1 | uint8_t | 1 | 从机ID1，固定为 `0xD8` |
| 3 | reg_acc | uint8_t | 1 | 加速度寄存器，固定为 `0x01` |
| 4-7 | accx_u32 | uint32_t | 4 | X轴加速度（IEEE 754 float，以小端序存储） |
| 8-11 | accy_u32 | uint32_t | 4 | Y轴加速度（IEEE 754 float，以小端序存储） |
| 12-15 | accz_u32 | uint32_t | 4 | Z轴加速度（IEEE 754 float，以小端序存储） |
| 16-17 | crc1 | uint16_t | 2 | CRC16校验值（低字节在前，高字节在后） |

#### 第二段：角速度数据（17字节）

| 偏移 | 字段名 | 类型 | 大小(字节) | 说明 |
|------|--------|------|-----------|------|
| 18 | FrameHeader2 | uint8_t | 1 | 帧头2，固定为 `0x55` |
| 19 | flag2 | uint8_t | 1 | 标志2，固定为 `0xAA` |
| 20 | slave_id2 | uint8_t | 1 | 从机ID2，固定为 `0xD8` |
| 21 | reg_gyro | uint8_t | 1 | 角速度寄存器，固定为 `0x02` |
| 22-25 | gyrox_u32 | uint32_t | 4 | X轴角速度（IEEE 754 float，以小端序存储） |
| 26-29 | gyroy_u32 | uint32_t | 4 | Y轴角速度（IEEE 754 float，以小端序存储） |
| 30-33 | gyroz_u32 | uint32_t | 4 | Z轴角速度（IEEE 754 float，以小端序存储） |
| 34-35 | crc2 | uint16_t | 2 | CRC16校验值（低字节在前，高字节在后） |

#### 第三段：欧拉角数据（17字节）

| 偏移 | 字段名 | 类型 | 大小(字节) | 说明 |
|------|--------|------|-----------|------|
| 36 | FrameHeader3 | uint8_t | 1 | 帧头3，固定为 `0x55` |
| 37 | flag3 | uint8_t | 1 | 标志3，固定为 `0xAA` |
| 38 | slave_id3 | uint8_t | 1 | 从机ID3，固定为 `0xD8` |
| 39 | reg_euler | uint8_t | 1 | 欧拉角寄存器，固定为 `0x03` |
| 40-43 | roll_u32 | uint32_t | 4 | Roll角度（IEEE 754 float，单位：度） |
| 44-47 | pitch_u32 | uint32_t | 4 | Pitch角度（IEEE 754 float，单位：度） |
| 48-51 | yaw_u32 | uint32_t | 4 | Yaw角度（IEEE 754 float，单位：度） |
| 52-53 | crc3 | uint16_t | 2 | CRC16校验值（低字节在前，高字节在后） |
| 54 | FrameEnd1 | uint8_t | 1 | 帧尾1 |
| 55 | FrameEnd2 | uint8_t | 1 | 帧尾2 |
| 56 | FrameEnd3 | uint8_t | 1 | 帧尾3 |

### 帧头识别

数据帧的帧头为固定的4字节序列：`0x55 0xAA 0xD8 0x01`

- 第一个字节：`0x55` - 帧头标识
- 第二个字节：`0xAA` - 标志位
- 第三个字节：`0xD8` - 从机ID
- 第四个字节：`0x01` - 加速度寄存器地址

### CRC16校验

- **校验算法**：使用DM设备专用的CRC16查表算法
- **校验范围**：每个子段的16字节数据（从帧头到数据结束，不包括CRC字段）
- **字节序**：CRC值以低字节在前、高字节在后的方式存储
- **校验表**：使用设备提供的256字节CRC16查表（`DM_CRC16_TABLE`）
- **初始值**：`0xFFFF`

**CRC计算示例：**
```cpp
// 对第一段数据计算CRC16（16字节：FrameHeader1到accz_u32）
uint16_t crc1_calc = dm_crc16_ccitt(
    reinterpret_cast<uint8_t *>(&receive_data.FrameHeader1), 
    16
);
```

### 数据解析

1. **帧头验证**：读取前4字节，验证是否为 `0x55 0xAA 0xD8 0x01`
2. **数据读取**：读取剩余53字节（共57字节）
3. **CRC校验**：对三个子段分别进行CRC16校验
4. **数据转换**：将 `uint32_t` 类型的数据按IEEE 754标准解释为 `float`
5. **四元数转换**：将欧拉角（度）转换为四元数（使用ZYX顺序：先绕Z轴旋转yaw，再绕Y轴旋转pitch，最后绕X轴旋转roll）

### 数据单位

- **加速度**：m/s²
- **角速度**：度/秒 或 rad/s（根据设备文档）
- **欧拉角**：度（代码中转换为弧度用于四元数计算）

### 错误处理

- 帧头不正确：记录日志，继续等待下一帧
- CRC校验失败：记录警告日志，丢弃当前数据帧
- 串口未打开：记录警告日志

### 数据队列

- 使用线程安全队列存储IMU数据（四元数 + 时间戳）
- 队列容量：5000条数据
- 支持时间戳插值查询，使用四元数球面线性插值（SLERP）

